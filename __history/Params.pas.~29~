unit Params;

interface

uses
  System.SysUtils, System.Types, System.UITypes, System.Classes, System.Variants,
  FMX.Types, FMX.Controls, FMX.Forms, FMX.Graphics, FMX.Dialogs, FMX.StdCtrls,
  FMX.Objects, FMX.Edit, FMX.Controls.Presentation, System.IOUtils,
  FireDAC.Comp.Client, FireDAC.Stan.Param, Data.DB, Winapi.Windows;

type
  TForm8 = class(TForm)
    Label1: TLabel;
    Label2: TLabel;
    Edit1: TEdit;
    Edit2: TEdit;
    Image1: TImage;
    Button1: TButton;
    Button2: TButton;
    OpenDialog1: TOpenDialog;
    Edit3: TEdit;
    Label3: TLabel;
    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure Button2Click(Sender: TObject);
  private
    procedure InitGroupe;
    procedure VerifierTableGroupe;
  public
  end;

var
  Form8: TForm8;

implementation

{$R *.fmx}

uses base;

{ ----------------------------------------------------------------------------- }
{ Vérifie que la table t_groupe existe, sinon la crée }
procedure TForm8.VerifierTableGroupe;
begin
  try
    DataModule1.FDConnection1.ExecSQL(
      'CREATE TABLE IF NOT EXISTS t_groupe (' +
      'id INTEGER PRIMARY KEY AUTOINCREMENT,' +
      'nomSetting TEXT,' +
      'adresseSetting TEXT,' +
      'photoSetting TEXT)'
    );
  except
    on E: Exception do
      ShowMessage('Erreur lors de la vérification de la table t_groupe : ' + E.Message);
  end;
end;

{ ----------------------------------------------------------------------------- }
{ Charger une image dans le TImage }
procedure TForm8.Button1Click(Sender: TObject);
begin
  if OpenDialog1.Execute then
    Image1.Bitmap.LoadFromFile(OpenDialog1.FileName);
end;

{ ----------------------------------------------------------------------------- }
{ Sauvegarde ou mise à jour du groupe (un seul enregistrement) }
procedure TForm8.Button2Click(Sender: TObject);
var
  Q: TFDQuery;
  ImgDir, ImgFile, ImgName: string;
begin
  if (Trim(Edit1.Text) = '') or (Trim(Edit2.Text) = '') or (Trim(Edit3.Text) = '')then
  begin
    ShowMessage('Veuillez remplir Nom du Groupe, Nom du Président et l’adresse.');
    Exit;
  end;

  // Création du dossier pour l’image
  ImgDir := TPath.Combine(ExtractFilePath(ParamStr(0)), 'ImagesGroupe');
  if not TDirectory.Exists(ImgDir) then
    TDirectory.CreateDirectory(ImgDir);

     // Rendre le dossier caché
  SetFileAttributes(PWideChar(ImgDir), FILE_ATTRIBUTE_HIDDEN);

  // Nom du fichier image basé sur le nom du groupe
  ImgName := StringReplace(Edit1.Text, ' ', '_', [rfReplaceAll]) + '.jpg';
  ImgFile := TPath.Combine(ImgDir, ImgName);

  if not Image1.Bitmap.IsEmpty then
    Image1.Bitmap.SaveToFile(ImgFile);

  // Vérifier/Créer la table une seule fois
  VerifierTableGroupe;

  Q := TFDQuery.Create(nil);
  try
    Q.Connection := DataModule1.FDConnection1;
    Q.SQL.Text := 'SELECT COUNT(*) AS nb FROM t_groupe';
    Q.Open;

    if Q.FieldByName('nb').AsInteger = 0 then
    begin
      // Aucun enregistrement → INSERT
      Q.Close;
      Q.SQL.Text :=
        'INSERT INTO t_groupe (nomSetting,presidentSetting, adresseSetting, photoSetting) VALUES (:n, :a,:s, :p)';
      Q.ParamByName('n').AsString := Uppercase(Edit1.Text);
      Q.ParamByName('a').AsString := Edit2.Text;
      Q.ParamByName('s').AsString := Edit3.Text;
      Q.ParamByName('p').AsString := ImgName;
      Q.ExecSQL;
      ShowMessage('Groupe enregistré avec succès.');
    end
    else
    begin
      // Déjà existant → UPDATE
      Q.Close;
      Q.SQL.Text :=
        'UPDATE t_groupe SET nomSetting = :n, presidentSetting = :a,adresseSetting = :s, photoSetting = :p WHERE id = 1';
      Q.ParamByName('n').AsString := Uppercase(Edit1.Text);
      Q.ParamByName('a').AsString := Edit2.Text;
      Q.ParamByName('s').AsString := Edit3.Text;
      Q.ParamByName('p').AsString := ImgName;
      Q.ExecSQL;
      ShowMessage('Informations mises à jour.');
    end;
  finally
    Q.Free;
  end;
end;

{ ----------------------------------------------------------------------------- }
{ Chargement des informations au démarrage }
procedure TForm8.InitGroupe;
var
  Q: TFDQuery;
  PhotoPath: string;
begin
  VerifierTableGroupe;

  Q := TFDQuery.Create(nil);
  try
    Q.Connection := DataModule1.FDConnection1;
    Q.SQL.Text := 'SELECT * FROM t_groupe LIMIT 1';
    Q.Open;

    if not Q.IsEmpty then
    begin
      Edit1.Text := Q.FieldByName('nomSetting').AsString;
      Edit2.Text := Q.FieldByName('presidentSetting').AsString;
      Edit3.Text := Q.FieldByName('adresseSetting').AsString;

      PhotoPath := TPath.Combine(ExtractFilePath(ParamStr(0)) + 'ImagesGroupe\', Q.FieldByName('photoSetting').AsString);
      if TFile.Exists(PhotoPath) then
        Image1.Bitmap.LoadFromFile(PhotoPath)
      else
        Image1.Bitmap.SetSize(0, 0); // vide proprement
    end;
  finally
    Q.Free;
  end;
end;

{ ----------------------------------------------------------------------------- }
procedure TForm8.FormCreate(Sender: TObject);
begin
  Position := TFormPosition.ScreenCenter;
  Button1.Text := 'Cliquer ici pour importer une photo';
  Button2.Text := 'Enregistrer';
end;

{ ----------------------------------------------------------------------------- }
procedure TForm8.FormShow(Sender: TObject);
begin
  Caption := 'GESTION DE GROUPE (Informations du Groupe)';
  Position := TFormPosition.ScreenCenter;
  InitGroupe;
  Button1.Text := 'Cliquer ici pour importer une photo';
  Button2.Text := 'Enregistrer';
end;

end.

